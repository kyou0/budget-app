<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’° å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª v2.0 - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <!-- PWAå¯¾å¿œ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª">

    <style>
        /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* --- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ --- */
        .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-card { background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); max-width: 400px; width: 100%; }
        .login-card h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2.5em; }
        .login-card p { color: #6c757d; margin-bottom: 30px; font-size: 1.1em; }
        .google-login-btn, .local-login-btn { background: #4285f4; color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3); margin-bottom: 15px; }
        .local-login-btn { background: #28a745; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); }
        .google-login-btn:hover { background: #3367d6; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4); }
        .local-login-btn:hover { background: #218838; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4); }

        /* --- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª --- */
        .app-container { display: none; max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .header h1 { color: #2c3e50; font-size: 2em; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .logout-btn { background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .navigation { display: flex; gap: 10px; flex-wrap: wrap; }
        .nav-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; text-decoration: none; display: inline-block; }
        .nav-btn.active { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); }
        .controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-top: 15px; }
        .month-selector { display: flex; align-items: center; gap: 10px; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); }
        .current-month { font-size: 1.2em; font-weight: bold; color: #2c3e50; min-width: 120px; text-align: center; }

        /* --- é€šçŸ¥ --- */
        .sync-notification { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); z-index: 1000; font-weight: 600; animation: slideIn 0.3s ease; }
        .sync-notification.warning { background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%); }
        .sync-notification.info { background: linear-gradient(135deg, #4285f4 0%, #3367d6 100%); }
        .sync-notification.error { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ --- */
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .summary-card { background: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .summary-card h3 { font-size: 0.9em; margin-bottom: 10px; color: #6c757d; display: flex; align-items: center; gap: 8px; }
        .summary-card .amount { font-size: 1.8em; font-weight: bold; color: #2c3e50; }
        .summary-card .amount.income { color: #28a745; }
        .summary-card .amount.expense { color: #dc3545; }
        .summary-card .sub-text { font-size: 0.8em; color: #6c757d; margin-top: 5px; height: 1.2em; }

        /* --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ --- */
        .calendar-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        .calendar-header {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .calendar-day-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
        }
        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 8px;
            position: relative;
            border: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .calendar-day.other-month {
            background: #f8f9fa;
            opacity: 0.5;
        }
        .calendar-day.today {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        .calendar-item {
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-bottom: 2px;
            cursor: pointer;
            transition: transform 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .calendar-item:hover {
            transform: scale(1.05);
        }
        .calendar-item.income { background: #28a745; }
        .calendar-item.expense { background: #dc3545; }
        .calendar-item.loan { background: #ffc107; color: #000; }
        .calendar-item.overdue {
            border: 2px dashed #dc3545;
            animation: blink 1.5s infinite;
        }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* --- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– --- */
        @media (max-width: 768px) {
            .controls, .navigation {
                flex-direction: column;
                align-items: stretch;
            }
            .calendar { font-size: 0.8em; }
            .calendar-day { min-height: 80px; }
        }
    </style>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://unpkg.com/jwt-decode/build/jwt-decode.js"></script>
</head>
<body>
<!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
<div id="loginScreen" class="login-screen">
    <div class="login-card">
        <h1>ğŸ’° å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª</h1>
        <p>æ»ç´é˜²æ­¢ãƒ»å€Ÿé‡‘ç®¡ç†ã«ç‰¹åŒ–ã—ãŸ<br>ã‚ãªãŸå°‚ç”¨ã®å®¶è¨ˆç°¿ã‚·ã‚¹ãƒ†ãƒ </p>
        <button class="google-login-btn" onclick="tryGoogleLogin()">ğŸ” Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="local-login-btn" onclick="localLogin()">ğŸ“± ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§é–‹å§‹</button>
    </div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª -->
<div id="appContainer" class="app-container">
    <div class="header">
        <div class="header-top">
            <h1>ğŸ’° ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <div class="user-info">
                <span id="userName">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
        <div class="navigation">
            <button class="nav-btn active">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
            <button class="nav-btn" onclick="goToMasterManagement()">âš™ï¸ ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†</button>
            <button class="nav-btn" onclick="goToSettings()">ğŸ”§ è¨­å®š</button>
        </div>
        <div class="controls">
            <div class="month-selector">
                <button class="btn" onclick="changeMonth(-1)">â—€ å‰æœˆ</button>
                <div class="current-month" id="currentMonth">2025å¹´7æœˆ</div>
                <button class="btn" onclick="changeMonth(1)">æ¬¡æœˆ â–¶</button>
            </div>
            <button class="btn" onclick="checkOverdueRisk()">âš ï¸ æ»ç´ãƒã‚§ãƒƒã‚¯</button>
        </div>
    </div>

    <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
    <div class="summary-cards">
        <div class="summary-card">
            <h3>ğŸ’° ä»Šæœˆåå…¥äºˆå®š</h3>
            <div class="amount income" id="summaryIncome">Â¥0</div>
        </div>
        <div class="summary-card">
            <h3>ğŸ’¸ ä»Šæœˆæ”¯å‡ºäºˆå®š</h3>
            <div class="amount expense" id="summaryExpense">Â¥0</div>
        </div>
        <div class="summary-card">
            <h3>âš–ï¸ æœˆæœ«äºˆæƒ³æ®‹é«˜</h3>
            <div class="amount" id="summaryBalance">Â¥0</div>
        </div>
        <div class="summary-card">
            <h3>ğŸ—“ï¸ ä»Šé€±ã®æ”¯æ‰•ã„</h3>
            <div class="amount expense" id="summaryWeekly">Â¥0</div>
        </div>
        <div class="summary-card">
            <h3>ğŸ¦ ç·å€Ÿå…¥æ®‹é«˜</h3>
            <div class="amount expense" id="summaryTotalDebt">Â¥0</div>
        </div>
        <div class="summary-card">
            <h3>ğŸ’³ æœˆé–“è¿”æ¸ˆé¡</h3>
            <div class="amount" id="summaryMonthlyRepayment">Â¥0</div>
        </div>
        <div class="summary-card">
            <h3>ğŸ å®Œæ¸ˆäºˆå®š</h3>
            <div class="amount" id="summaryCompletionDate">--</div>
            <div class="sub-text" id="summaryCompletionSubtext"></div>
        </div>
    </div>

    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
    <div class="calendar-container">
        <h2 class="calendar-header">ğŸ“… ä»Šæœˆã®æ”¯æ‰•ã„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
        <div class="calendar" id="calendar"></div>
    </div>
</div>

<script>
  // ===================================================================================
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  // ===================================================================================
  const GOOGLE_CLIENT_ID = '138150284146-07ul0ennhq22tm0ih3hngv8pnjsgo1u3.apps.googleusercontent.com';
  let masterData = [];
  let currentUser = null;
  let loginMode = 'local';
  let currentYear = new Date().getFullYear();
  let currentMonth = new Date().getMonth() + 1;

  // ===================================================================================
  // åˆæœŸåŒ–å‡¦ç†
  // ===================================================================================
  document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª v2.0 èµ·å‹•');

    // Googleãƒ­ã‚°ã‚¤ãƒ³ã®åˆæœŸåŒ–
    try {
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleGoogleLoginSuccess // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã«å‘¼ã°ã‚Œã‚‹é–¢æ•°
      });
    } catch (e) {
      console.error("Google Sign-Inã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„ã‹ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDãŒä¸æ­£ã§ã™ã€‚", e);
    }

    // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’å¾©å…ƒã—ã‚ˆã†ã¨è©¦ã¿ã‚‹
    const savedUserJSON = localStorage.getItem('budgetAppUser');
    if (savedUserJSON && savedUserJSON !== 'undefined' && savedUserJSON !== 'null') {
      try {
        const user = JSON.parse(savedUserJSON);
        if (user && typeof user === 'object' && user.name && user.mode) {
          currentUser = user;
          loginMode = user.mode;
          showApp();
          return;
        } else {
          console.warn('ä¿å­˜ã•ã‚Œã¦ã„ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ãªå½¢å¼ã§ã™ã€‚');
          localStorage.removeItem('budgetAppUser');
        }
      } catch (e) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
        localStorage.removeItem('budgetAppUser');
      }
    }
  });

  function showApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
    document.getElementById('userName').textContent = currentUser.name;
    initializeApp();
  }

  function initializeApp() {
    loadData();
    renderAll();
    showNotification(`âœ… ${currentUser.name}ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ`);
  }

  function renderAll() {
    updateCurrentMonthDisplay();
    generateCalendar();
    updateSummaryCards();
  }

  // ===================================================================================
  // èªè¨¼ & ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
  // ===================================================================================
  /**
   * Googleãƒ­ã‚°ã‚¤ãƒ³ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤ºã™ã‚‹
   */
  function tryGoogleLogin() {
    try {
      // Googleã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
      google.accounts.id.prompt();
    } catch (e) {
      console.error("Googleãƒ­ã‚°ã‚¤ãƒ³ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚", e);
      showNotification('Googleãƒ­ã‚°ã‚¤ãƒ³ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã¿ã¦ãã ã•ã„ã€‚', 'error');
    }
  }

  /**
   * Googleãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
   * @param {object} response - Googleã‹ã‚‰ã®èªè¨¼æƒ…å ±
   */
  function handleGoogleLoginSuccess(response) {
    console.log("Googleã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å—ã‘å–ã‚Šã¾ã—ãŸ:", response);
    // jwt-decodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ã€èªè¨¼æƒ…å ±(JWT)ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æŠœãå‡ºã™
    const userObject = jwt_decode(response.credential);

    currentUser = {
      name: userObject.name,
      email: userObject.email,
      mode: 'google'
    };
    loginMode = 'google';

    localStorage.setItem('budgetAppUser', JSON.stringify(currentUser));
    showApp();
  }

  function localLogin() {
    currentUser = { name: 'ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼', mode: 'local' };
    loginMode = 'local';
    localStorage.setItem('budgetAppUser', JSON.stringify(currentUser));
    showApp();
  }

  function logout() {
    // Googleã‹ã‚‰ã‚‚ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã™ã‚‹
    if (loginMode === 'google' && typeof google !== 'undefined') {
      google.accounts.id.disableAutoSelect();
    }
    currentUser = null;
    localStorage.removeItem('budgetAppUser');
    // ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã™ã®ãŒä¸€ç•ªç¢ºå®Ÿ
    window.location.reload();
  }

  // ===================================================================================
  // ãƒ‡ãƒ¼ã‚¿ç®¡ç†
  // ===================================================================================
  function loadData() {
    try {
      const savedMaster = localStorage.getItem('budgetMasterData');
      if (savedMaster && savedMaster !== 'undefined' && JSON.parse(savedMaster).length > 0) {
        masterData = JSON.parse(savedMaster);
        console.log('ğŸ“‚ ä¿å­˜ã•ã‚ŒãŸãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚');
      } else {
        loadSampleData();
        localStorage.setItem('budgetMasterData', JSON.stringify(masterData));
      }
    } catch (e) {
      console.error("ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§åˆæœŸåŒ–ã—ã¾ã™ã€‚", e);
      localStorage.removeItem('budgetMasterData'); // ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
      loadSampleData();
      localStorage.setItem('budgetMasterData', JSON.stringify(masterData));
    }
  }

  function loadSampleData() {
    masterData = [
      { id: 'item_1', name: "ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆA", type: "income", paymentDay: 10, amount: 200000, paymentMethod: "éŠ€è¡ŒæŒ¯è¾¼", isActive: true },
      { id: 'item_3', name: "å®¶è³ƒ", type: "fixed", paymentDay: 27, amount: -80000, paymentMethod: "éŠ€è¡ŒæŒ¯è¾¼", isActive: true },
      { id: 'item_5', name: "ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰", type: "card", paymentDay: 4, amount: -50000, paymentMethod: "ãƒ¡ã‚¤ãƒ³éŠ€è¡Œ", isActive: true },
      { id: 'item_8', name: "ã‚¢ã‚³ãƒ ", type: "loan", paymentDay: 27, amount: -15000, paymentMethod: "ãƒ¡ã‚¤ãƒ³éŠ€è¡Œ", isActive: true, loanDetails: { loanType: "æ¶ˆè²»è€…é‡‘è", interestRate: 18.0, maxLimit: 500000, currentBalance: 234567 } },
      { id: 'item_9', name: "æ¥½å¤©ã‚«ãƒ¼ãƒ‰ãƒ­ãƒ¼ãƒ³", type: "loan", paymentDay: 12, amount: -12000, paymentMethod: "æ¥½å¤©éŠ€è¡Œ", isActive: true, loanDetails: { loanType: "ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰", interestRate: 15.0, maxLimit: 1000000, currentBalance: 450000 } }
    ];
    showNotification('ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚', 'info');
  }

  // ===================================================================================
  // UIæç”» & æ›´æ–°
  // ===================================================================================
  function changeMonth(delta) {
    currentMonth += delta;
    if (currentMonth > 12) {
      currentMonth = 1;
      currentYear++;
    } else if (currentMonth < 1) {
      currentMonth = 12;
      currentYear--;
    }
    renderAll();
  }

  function updateCurrentMonthDisplay() {
    document.getElementById('currentMonth').textContent = `${currentYear}å¹´${currentMonth}æœˆ`;
  }

  function generateCalendar() {
    const calendar = document.getElementById('calendar');
    calendar.innerHTML = '';
    const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
    weekdays.forEach(day => {
      const header = document.createElement('div');
      header.className = 'calendar-day-header';
      header.textContent = day;
      calendar.appendChild(header);
    });

    const firstDayOfMonth = new Date(currentYear, currentMonth - 1, 1);
    const startingDay = firstDayOfMonth.getDay();
    const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();

    for (let i = 0; i < startingDay; i++) {
      calendar.insertAdjacentHTML('beforeend', '<div class="calendar-day other-month"></div>');
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const dayElement = document.createElement('div');
      dayElement.className = 'calendar-day';
      const today = new Date();
      if (currentYear === today.getFullYear() && currentMonth === today.getMonth() + 1 && day === today.getDate()) {
        dayElement.classList.add('today');
      }
      dayElement.innerHTML = `<div class="day-number">${day}</div>`;

      const itemsForDay = masterData.filter(item => item.isActive && item.paymentDay === day);
      itemsForDay.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'calendar-item';
        const icon = { income: 'ğŸ’°', expense: 'ğŸ’¸', loan: 'ğŸ¦', card: 'ğŸ’³', fixed: 'ğŸ ', tax: 'ğŸ›ï¸', bank: 'ğŸ¦', variable: 'ğŸ›’' }[item.type] || 'ğŸ“„';
        itemElement.innerHTML = `${icon} ${item.name}`;
        itemElement.title = `${item.name}: ${item.amount.toLocaleString()}å††`;
        if (item.amount > 0) itemElement.classList.add('income');
        else if (item.type === 'loan') itemElement.classList.add('loan');
        else itemElement.classList.add('expense');
        dayElement.appendChild(itemElement);
      });
      calendar.appendChild(dayElement);
    }
  }

  function updateSummaryCards() {
    const activeItems = masterData.filter(item => item.isActive);
    const income = activeItems.filter(i => i.amount > 0).reduce((sum, i) => sum + i.amount, 0);
    const expense = activeItems.filter(i => i.amount < 0).reduce((sum, i) => sum + i.amount, 0);

    const today = new Date();
    const weekEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 7);
    const weeklyExpense = activeItems.filter(i => {
      if (i.amount >= 0 || !i.paymentDay) return false;
      const paymentDateThisMonth = new Date(currentYear, currentMonth - 1, i.paymentDay);
      return paymentDateThisMonth >= today && paymentDateThisMonth < weekEnd;
    }).reduce((sum, i) => sum + i.amount, 0);

    const loanItems = activeItems.filter(i => i.type === 'loan');
    const totalDebt = loanItems.reduce((sum, i) => sum + (i.loanDetails?.currentBalance || 0), 0);
    const monthlyRepayment = loanItems.reduce((sum, i) => sum + Math.abs(i.amount), 0);

    document.getElementById('summaryIncome').textContent = `Â¥${income.toLocaleString()}`;
    document.getElementById('summaryExpense').textContent = `Â¥${Math.abs(expense).toLocaleString()}`;
    document.getElementById('summaryBalance').textContent = `Â¥${(income + expense).toLocaleString()}`;
    document.getElementById('summaryWeekly').textContent = `Â¥${Math.abs(weeklyExpense).toLocaleString()}`;
    document.getElementById('summaryTotalDebt').textContent = `Â¥${totalDebt.toLocaleString()}`;
    document.getElementById('summaryMonthlyRepayment').textContent = `Â¥${monthlyRepayment.toLocaleString()}`;

    // å®Œæ¸ˆäºˆå®šæ—¥ã®è¨ˆç®—
    const { years, months } = calculateCompletionDate(loanItems);
    if (years > 0 || months > 0) {
      let completionText = '';
      if (years > 0) completionText += `${years}å¹´`;
      if (months > 0) completionText += `${months}ãƒ¶æœˆ`;
      completionText += 'å¾Œ';

      document.getElementById('summaryCompletionDate').textContent = completionText;
      const completionDate = new Date();
      completionDate.setMonth(completionDate.getMonth() + (years * 12 + months));
      document.getElementById('summaryCompletionSubtext').textContent = `( ${completionDate.getFullYear()}å¹´${completionDate.getMonth() + 1}æœˆé ƒ )`;
    } else if (loanItems.length > 0 && monthlyRepayment > 0) {
      document.getElementById('summaryCompletionDate').textContent = "è¨ˆç®—ä¸å¯";
      document.getElementById('summaryCompletionSubtext').textContent = "è¿”æ¸ˆé¡ãŒåˆ©æ¯ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™";
    } else {
      document.getElementById('summaryCompletionDate').textContent = "å€Ÿå…¥ãªã—";
      document.getElementById('summaryCompletionSubtext').textContent = "";
    }
  }

  function calculateCompletionDate(loanItems) {
    if (loanItems.length === 0) return { years: 0, months: 0 };
    let maxMonths = 0;
    loanItems.forEach(loan => {
      const balance = loan.loanDetails?.currentBalance || 0;
      const monthlyPayment = Math.abs(loan.amount) || 0;
      const annualRate = loan.loanDetails?.interestRate || 0;
      if (balance <= 0 || monthlyPayment <= 0) return;
      if (annualRate === 0) {
        const months = Math.ceil(balance / monthlyPayment);
        if (months > maxMonths) maxMonths = months;
        return;
      }
      const monthlyRate = annualRate / 100 / 12;
      const minPayment = balance * monthlyRate;
      if (monthlyPayment <= minPayment) {
        maxMonths = Infinity;
        return;
      }
      const num = -Math.log(1 - (balance * monthlyRate) / monthlyPayment);
      const den = Math.log(1 + monthlyRate);
      const months = Math.ceil(num / den);
      if (months > maxMonths) maxMonths = months;
    });
    if (maxMonths === Infinity || !isFinite(maxMonths)) return { years: 0, months: 0 };
    const years = Math.floor(maxMonths / 12);
    const months = maxMonths % 12;
    return { years, months };
  }

  // ===================================================================================
  // æ©Ÿèƒ½ & ãƒšãƒ¼ã‚¸é·ç§»
  // ===================================================================================
  function checkOverdueRisk() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const overdueItems = masterData.filter(item => {
      if (!item.isActive || item.amount >= 0 || !item.paymentDay) return false;
      const paymentDate = new Date(currentYear, currentMonth - 1, item.paymentDay);
      return paymentDate < today && paymentDate.getMonth() === currentMonth - 1;
    });
    if (overdueItems.length > 0) {
      let message = 'âš ï¸ ä»¥ä¸‹ã®é …ç›®ãŒæ”¯æ‰•æœŸæ—¥ã‚’éãã¦ã„ã¾ã™ï¼\n\n';
      overdueItems.forEach(item => {
        message += `â€¢ ${item.paymentDay}æ—¥: ${item.name} (${Math.abs(item.amount).toLocaleString()}å††)\n`;
      });
      alert(message);
      showNotification('âš ï¸ æ»ç´ãƒªã‚¹ã‚¯ãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸ', 'warning');
    } else {
      showNotification('âœ… ç¾æ™‚ç‚¹ã§æ»ç´ã—ã¦ã„ã‚‹é …ç›®ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
    }
  }

  function goToMasterManagement() {
    window.location.href = 'master.html';
  }

  function goToSettings() {
    window.location.href = 'settings.html';
  }

  // ===================================================================================
  // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  // ===================================================================================
  function showNotification(message, type = 'success') {
    const existing = document.querySelector('.sync-notification');
    if (existing) existing.remove();
    const notification = document.createElement('div');
    notification.className = `sync-notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => {
      notification.style.animation = 'slideIn 0.3s ease reverse';
      setTimeout(() => notification.remove(), 300);
    }, 4000);
  }
</script>

</body>
</html>